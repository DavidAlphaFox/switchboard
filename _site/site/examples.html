<h2 id="examples">Examples</h2>

<!-- TODO - add python client -->

<p>Switchboard allows developers to develop a wide variety of clients.
This section will point you towards existing example clients, as well
as walk you through how to write your own client in Ruby.</p>

<p>Switchboard’s first role was sending new email push notifications to
the <a href="http://spatch.co">Spatch iOS app</a>. Due to mobile process
backgrounding restrictions and battery abuse, it’s difficult to
monitor for new emails client-side. Instead, the Spatch app securely
posts users’ OAuth tokens to a server running Switchboard, which
begins to monitor the accounts for incoming emails. When a new email
arrives, Switchboard notifies a subscribed worker, which then sends
down a push notification to the app.</p>

<p>In this case, Switchboard handled creating the IMAP connections,
keeping tabs on new emails coming down, and giving the worker
the data that it needed to send down a nicely formatted push
notification.</p>

<h3 id="python-workerclient-and-examples">Python Worker/Client and Examples</h3>

<p>There is a Switchboard worker/client
<a href="https://github.com/jtmoulia/switchboard-python">Python implementation</a>.
The repository’s README explains how to get connected to Switchboard,
and run the examples.</p>

<p>The examples include workers for:</p>

<ul class="bulletPoints1">
  <li>
    Sending Apple push notifications to an iOS app as new emails arrive.
  </li>
  <li>
    Sending a text message via <a href="https://www.twilio.com/">Twilio</a>
    as new emails arrive.
  </li>
</ul>

<h3 id="javascript-workerclient">Javascript Worker/Client</h3>

<p>Since the Switchboard protocol uses JSON over WebSockets, it’s only fitting for
there to be a JavaScript client. Switchboard comes packaged with one.</p>

<p>To try the client out, start the Switchboard application and point
your browser at
<code>http://127.0.0.1:8080/jsclient</code> - it
should display a page with some getting started commands. Open your
browser’s javascript console and try them out.  The sourcefile
contains comments mapping out common components of a Switchboard
client, and is a great reference for understanding the interfaces.</p>

<h3 id="ruby-sample-app-tutorial---email-dropbox-uploader">Ruby Sample App Tutorial - Email Dropbox Uploader</h3>

<p>Follow this example tutorial to build your first Switchboard client
in Ruby. This simple example, to be run in the command line, syncs
attachments from a user’s emails to his or her Dropbox.</p>

<h4 id="setup">Setup</h4>

<p>First off, make sure switchboard is running on your local server (see
<a href="/switchboard/install/" title="Installation">Switchboard Installation</a> for details)</p>

<p>After the Switchboard server is up, you’re ready to start building
your Ruby client so you can communicate with it.</p>

<p>To get started, create the following <code>Gemfile</code>:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
<span class="n">ruby</span> <span class="s1">&#39;2.1.1&#39;</span> <span class="c1"># we haven&#39;t tested other versions yet. Let us know if you have any issues</span>

<span class="n">gem</span> <span class="s1">&#39;faye-websocket&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;Dropbox-sdk&#39;</span></code></pre></div>

<p><code>faye-websocket</code> is a pretty handy gem extracted from the
<a href="https://github.com/faye/faye-websocket-ruby">faye project</a>, which
provides classes for easily building WebSocket servers and clients in Ruby. 
Dropbox’s ‘<a href="https://www.Dropbox.com/developers/core/start/ruby">ruby SDK</a>’ 
is well developed and documented, which will make it
simple to upload files to your Dropbox.</p>

<h4 id="the-initial-client">The initial client</h4>

<p>The beginnings of the client come straight from the
<a href="https://github.com/faye/faye-websocket-ruby#using-the-websocket-client">faye-websocket documentation</a>,
it’s pretty easy to set up:</p>

<p><code>awesome-Dropbox-uploader.rb</code></p>

<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s1">&#39;faye/websocket&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;eventmachine&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;json&#39;</span>

<span class="no">EM</span><span class="o">.</span><span class="n">run</span> <span class="p">{</span>
  <span class="n">ws</span> <span class="o">=</span> <span class="no">Faye</span><span class="o">::</span><span class="no">WebSocket</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;ws://127.0.0.1:8080/clients&#39;</span><span class="p">)</span> <span class="c1"># this tutorial uses the default switchboard url -&gt; read below for an explanation.</span>

  <span class="n">ws</span><span class="o">.</span><span class="n">on</span> <span class="ss">:open</span> <span class="k">do</span> <span class="o">|</span><span class="n">event</span><span class="o">|</span>
    <span class="nb">p</span> <span class="o">[</span><span class="ss">:open</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="n">ws</span><span class="o">.</span><span class="n">on</span> <span class="ss">:message</span> <span class="k">do</span> <span class="o">|</span><span class="n">event</span><span class="o">|</span>
    <span class="nb">p</span> <span class="o">[</span><span class="ss">:message</span><span class="p">,</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="n">ws</span><span class="o">.</span><span class="n">on</span> <span class="ss">:close</span> <span class="k">do</span> <span class="o">|</span><span class="n">event</span><span class="o">|</span>
    <span class="nb">p</span> <span class="o">[</span><span class="ss">:close</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">reason</span><span class="o">]</span>
    <span class="n">ws</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">end</span>
<span class="p">}</span></code></pre></div>

<p>The <code>Faye::Websocket::Client</code> takes an url to listen to, so you can use
the default local Switchboard url. The client responds to the usual
websocket methods, which currently output notifications/data to the
console upon being called. When the client receives a message from the server,
it’ll parse it for later use.</p>

<p>If you execute <code>ruby your-file-name.rb</code> (we’ll call it
awesome-Dropbox-uploader.rb for the rest of the tutorial) you’ll see:</p>

<div class="highlight"><pre><code class="ruby"><span class="o">[</span><span class="ss">:open</span><span class="o">]</span></code></pre></div>

<p>…and nothing else. This is because without adding an account to
Switchboard it doesn’t know what to send your way. So close your 
client for the moment (<code>Ctrl + c</code>, upon which you’ll see a closing
message) and move on to the next section: adding an account.</p>

<h4 id="addinglistening-to-an-account">Adding/listening to an account</h4>

<p>The Switchboard client protocol is currently a subset of
<a href="http://jmap.io/">JMAP</a>, with data encoded in <code>UTF8 JSON</code>. Clients can
issue commands in the form <code>[["methodName", {options}]]</code>, using the
<code>send</code> method. This example uses Switchboard’s plain auth:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">ws</span><span class="o">.</span><span class="n">on</span> <span class="ss">:open</span> <span class="k">do</span> <span class="o">|</span><span class="n">event</span><span class="o">|</span>
  <span class="nb">p</span><span class="o">[</span><span class="ss">:open</span><span class="o">]</span>

  <span class="n">ws</span><span class="o">.</span><span class="n">send</span> <span class="s1">&#39;[</span>
<span class="s1">              [&quot;connect&quot;,</span>
<span class="s1">                {&quot;host&quot;: &quot;imap.gmail.com&quot;,</span>
<span class="s1">                  &quot;port&quot;: 993,</span>
<span class="s1">                  &quot;auth&quot;: {&quot;type&quot;: &quot;plain&quot;,</span>
<span class="s1">                            &quot;username&quot;: &quot;YOUR EMAIL&quot;,</span>
<span class="s1">                            &quot;password&quot;: &quot;YOUR PASSWORD&quot;</span>
<span class="s1">                          }</span>
<span class="s1">                }</span>
<span class="s1">              ]</span>
<span class="s1">            ]&#39;</span>
<span class="k">end</span></code></pre></div>

<p>This time, if you run our client (<code>ruby awesome-Dropbox-uploader.rb</code>)
it’ll automatically connect, and you should see the message</p>

<div class="highlight"><pre><code class="ruby"><span class="o">[</span><span class="ss">:message</span><span class="p">,</span> <span class="o">[[</span><span class="s2">&quot;connected&quot;</span><span class="p">,</span> <span class="p">{}</span><span class="o">]]]</span></code></pre></div>

<p>Although you’re now connected there’s one last thing you’ve got to do
before you’ll start getting emails through. We need to tell
Switchboard which mailbox to listen to. That’s easily done with the
<code>watchMailboxes</code> command, which takes as argument a list of mailboxes.</p>

<div class="highlight"><pre><code class="ruby"><span class="n">ws</span><span class="o">.</span><span class="n">send</span> <span class="s1">&#39;[[&quot;watchMailboxes&quot;, {&quot;list&quot;: [&quot;INBOX&quot;]}]]&#39;</span></code></pre></div>

<p>The server will respond with <code>[:message, [["watchedMailboxes", {}]]]</code></p>

<p>If you restart your client now, when you receive an email Switchboard
will automatically send through the email’s <code>messageId</code> and its <code>mailboxId</code>:</p>

<div class="highlight"><pre><code class="ruby"><span class="o">[</span><span class="s2">&quot;newMessage&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;mailboxId&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;INBOX!671882951&quot;</span><span class="p">,</span> <span class="s2">&quot;messageId&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;INBOX!671882951?2743&quot;</span><span class="p">}</span><span class="o">]</span></code></pre></div>

<p>By now you probably have noticed that messages sent from the server
take the following form:</p>

<div class="highlight"><pre><code class="ruby"><span class="o">[[</span><span class="s2">&quot;messageName&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">params</span><span class="p">}</span><span class="o">]]</span></code></pre></div>

<p>You can use this to make what’s output to your console when you receive
messages a little more specific:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">ws</span><span class="o">.</span><span class="n">on</span> <span class="ss">:message</span> <span class="k">do</span> <span class="o">|</span><span class="n">event</span><span class="o">|</span>
  <span class="n">m</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">flatten!</span>

  <span class="k">case</span> <span class="n">m</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="c1">#using the method name to decide what to do</span>
    <span class="k">when</span> <span class="s2">&quot;connected&quot;</span>
      <span class="nb">puts</span> <span class="s1">&#39;connection made&#39;</span>
    <span class="k">when</span> <span class="s2">&quot;idling&quot;</span>
      <span class="nb">puts</span> <span class="s1">&#39;idling away&#39;</span>
    <span class="k">when</span> <span class="s2">&quot;newMessage&quot;</span>
      <span class="nb">puts</span> <span class="s1">&#39;new message&#39;</span>
      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="c1">#the message content</span>
    <span class="k">else</span>
      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">m</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>Hardcoding an email and password is pretty simplistic, so let’s change that
to enable you to pass them in through the command line:</p>

<div class="highlight"><pre><code class="ruby"><span class="nb">puts</span> <span class="s2">&quot;let&#39;s add an account to switchboard&quot;</span>
<span class="nb">puts</span> <span class="s1">&#39;what is your email?&#39;</span>
<span class="n">email</span> <span class="o">=</span> <span class="nb">gets</span><span class="o">.</span><span class="n">strip</span>
<span class="nb">puts</span> <span class="s1">&#39;what is your password?&#39;</span>
<span class="n">password</span> <span class="o">=</span> <span class="nb">gets</span><span class="o">.</span><span class="n">strip</span></code></pre></div>

<p>You’ll need to interpolate the values into your command to the server (this means having to escape a lot of double quotation marks):</p>

<div class="highlight"><pre><code class="ruby"><span class="s2">&quot;[[</span><span class="se">\&quot;</span><span class="s2">connect</span><span class="se">\&quot;</span><span class="s2">, {</span><span class="se">\&quot;</span><span class="s2">host</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">imap.gmail.com</span><span class="se">\&quot;</span><span class="s2">,</span>
<span class="s2">                </span><span class="se">\&quot;</span><span class="s2">port</span><span class="se">\&quot;</span><span class="s2">: 993,</span>
<span class="s2">                </span><span class="se">\&quot;</span><span class="s2">auth</span><span class="se">\&quot;</span><span class="s2">: {</span><span class="se">\&quot;</span><span class="s2">type</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">plain</span><span class="se">\&quot;</span><span class="s2">,</span>
<span class="s2">                            </span><span class="se">\&quot;</span><span class="s2">username</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">,</span>
<span class="s2">                            </span><span class="se">\&quot;</span><span class="s2">password</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">password</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"></span>
<span class="s2">                          }</span>
<span class="s2">              }</span>
<span class="s2">]]&quot;</span></code></pre></div>

<p>Now when you run your ‘awesome-Dropbox-uploader’ you’re prompted to fill
in your Gmail username and password, then Switchboard automatically
connects and listens to your inbox for you. Pretty sweet!</p>

<p>So now your client’s in pretty good shape. Apart from one pretty
crucial thing - you’re not retrieving any attachments to
upload. Whoops.</p>

<p>In order to retrieve an attachment you need to use the <code>messageId</code> you
get upon receiving an email to make another call to Switchboard,
retrieving the specific email information you need. You can do this with
<code>getMessages</code>, which takes as arguments message ids and the email
properties you’re looking for, from subject to textBody.</p>

<p>Retrieving the attachments directly is still a work in progress, but
we can get around that by retrieving the raw email data in order to
parse it in your client:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">ws</span><span class="o">.</span><span class="n">on</span> <span class="ss">:message</span> <span class="k">do</span> <span class="o">|</span><span class="n">event</span><span class="o">|</span>
  <span class="n">m</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">flatten!</span>

  <span class="k">case</span> <span class="n">m</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="k">when</span> <span class="s2">&quot;newMessage&quot;</span>
      <span class="nb">puts</span> <span class="s1">&#39;new message&#39;</span>
      <span class="n">message_id</span> <span class="o">=</span> <span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">][</span><span class="s2">&quot;messageId&quot;</span><span class="o">]</span>
      <span class="n">ws</span><span class="o">.</span><span class="n">send</span> <span class="s2">&quot;[</span>
<span class="s2">                 [</span><span class="se">\&quot;</span><span class="s2">getMessages</span><span class="se">\&quot;</span><span class="s2">, </span>
<span class="s2">                  {</span>
<span class="s2">                    </span><span class="se">\&quot;</span><span class="s2">ids</span><span class="se">\&quot;</span><span class="s2">: [</span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">message_id</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">], </span>
<span class="s2">                    </span><span class="se">\&quot;</span><span class="s2">properties</span><span class="se">\&quot;</span><span class="s2">: [</span><span class="se">\&quot;</span><span class="s2">raw</span><span class="se">\&quot;</span><span class="s2">]</span>
<span class="s2">                  }</span>
<span class="s2">                ]</span>
<span class="s2">              ]&quot;</span>
    <span class="k">else</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>Now you have the raw email data. You can use the handy
<a href="https://github.com/mikel/mail">mail</a> gem to parse it and retrieve
your attachments. After adding and bundling the gem, you’re ready to
add a new case to the message method:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">ws</span><span class="o">.</span><span class="n">on</span> <span class="ss">:message</span> <span class="k">do</span> <span class="o">|</span><span class="n">event</span><span class="o">|</span>
  <span class="n">m</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">flatten!</span>

  <span class="k">case</span> <span class="n">m</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="k">when</span> <span class="s2">&quot;messages&quot;</span>
      <span class="c1"># first the client needs to retrieve the raw data from the server response</span>
      <span class="n">raw_msg</span> <span class="o">=</span> <span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">][</span><span class="s2">&quot;list&quot;</span><span class="o">][</span><span class="mi">0</span><span class="o">][</span><span class="s2">&quot;raw&quot;</span><span class="o">]</span>
      <span class="c1"># then parse it with the mail gem and retrieve the attachments</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">raw_msg</span><span class="p">)</span>
      <span class="n">attachments</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">attachments</span>
      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">attachments</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>Attachments are returned in an array. If an email has no attachments,
Switchboard will return an empty array. If you’re interested, an
attachment looks something like this:</p>

<div class="highlight"><pre><code class="ruby"><span class="o">[</span><span class="c1">#&lt;Mail::Part:2159230880, Multipart: false, Headers: 	&lt;Content-Type: image/jpeg; name=&quot;swag.jpg&quot;&gt;, 	&lt;Content-Transfer-Encoding: base64&gt;, &lt;Content-	Disposition: attachment; filename=&quot;swag.jpg&quot;&gt;, 	&lt;X-Attachment-Id: f_hw297rj60&gt;&gt;]</span></code></pre></div>

<h4 id="dropbox-authentication">Dropbox authentication</h4>

<p>Now the client is retrieving your email attachments, the next step
is to set up the Dropbox uploader. First off is authentication.</p>

<p>Setting up <code>Dropbox OAuth</code> is incredibly easy, and well documented. It
is a little awkward to use though, due to it being split into two
parts (authorising the app and then pasting in a confirmation code to
finish the process).</p>

<p>Here’s a quick implementation taken from the Dropbox docs (you’ll need
to register your app on the app console <a href="https://www.Dropbox.com/developers/apps">here</a> 
to get a key and secret first).</p>

<div class="highlight"><pre><code class="ruby"><span class="no">APP_KEY</span> <span class="o">=</span> <span class="s1">&#39;SOME KEY&#39;</span>
<span class="no">APP_SECRET</span> <span class="o">=</span> <span class="s1">&#39;SOME SECRET&#39;</span>

<span class="n">flow</span> <span class="o">=</span> <span class="no">DropboxOAuth2FlowNoRedirect</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">APP_KEY</span><span class="p">,</span> 	<span class="no">APP_SECRET</span><span class="p">)</span>

<span class="n">authorize_url</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="nb">puts</span> <span class="s1">&#39;1. Go to: &#39;</span> <span class="o">+</span> <span class="n">authorize_url</span>
<span class="nb">puts</span> <span class="s1">&#39;2. Click &quot;Allow&quot; (you might have to log in 	first)&#39;</span>
<span class="nb">puts</span> <span class="s1">&#39;3. Copy the authorization code&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;Enter the authorization code here: &#39;</span>
<span class="n">code</span> <span class="o">=</span> <span class="nb">gets</span><span class="o">.</span><span class="n">strip</span>

<span class="n">access_token</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="n">code</span><span class="p">)</span></code></pre></div>

<p>You can implement a simple Dropbox uploader using the access token stored when you authenticated with Dropbox, passing in the attachments from your emails:</p>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">DropboxUploader</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">upload_file</span><span class="p">(</span><span class="n">attachments</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
      <span class="n">attachments</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span> <span class="n">attachment</span> <span class="o">|</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">attachment</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">begin</span>
          <span class="n">file</span> <span class="o">=</span> <span class="n">attachment</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decoded</span>
          <span class="n">client</span> <span class="o">=</span> <span class="no">DropboxClient</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
          <span class="n">client</span><span class="o">.</span><span class="n">put_file</span><span class="p">(</span><span class="s2">&quot;/</span><span class="si">#{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
          <span class="nb">puts</span> <span class="s2">&quot;Unable to save data for </span><span class="si">#{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> because </span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>Add the uploader to your <code>messages</code> method and you’re good to go:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">ws</span><span class="o">.</span><span class="n">on</span> <span class="ss">:message</span> <span class="k">do</span> <span class="o">|</span><span class="n">event</span><span class="o">|</span>
  <span class="n">m</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">flatten!</span>

  <span class="k">case</span> <span class="n">m</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
    <span class="k">when</span> <span class="s2">&quot;messages&quot;</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>

      <span class="no">DropboxUploader</span><span class="o">::</span><span class="n">upload_file</span><span class="p">(</span><span class="n">attachments</span><span class="p">,</span> <span class="n">access_token</span><span class="p">)</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>And there you have it. A quick command line application that syncs
your email attachments with your Dropbox, and shows off the awesome
power of Switchboard.</p>

<h4 id="tidying-up">Tidying up</h4>

<p>You can start extracting out the code into classes to neaten things up
a bit, for example:</p>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">SwitchboardClient</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
      <span class="n">ws</span><span class="o">.</span><span class="n">send</span> <span class="n">authorisation</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>

      <span class="n">ws</span><span class="o">.</span><span class="n">send</span> <span class="s1">&#39;[[&quot;idle&quot;, {&quot;list&quot;: [&quot;INBOX&quot;]}]]&#39;</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">authorisation</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
      <span class="s2">&quot;[[</span><span class="se">\&quot;</span><span class="s2">connect</span><span class="se">\&quot;</span><span class="s2">, {</span><span class="se">\&quot;</span><span class="s2">host</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">imap.gmail.com</span><span class="se">\&quot;</span><span class="s2">,</span>
<span class="s2">                 </span><span class="se">\&quot;</span><span class="s2">port</span><span class="se">\&quot;</span><span class="s2">: 993,</span>
<span class="s2">                 </span><span class="se">\&quot;</span><span class="s2">auth</span><span class="se">\&quot;</span><span class="s2">: {</span><span class="se">\&quot;</span><span class="s2">type</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">plain</span><span class="se">\&quot;</span><span class="s2">,</span>
<span class="s2">                         </span><span class="se">\&quot;</span><span class="s2">username</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">,</span>
<span class="s2">                         </span><span class="se">\&quot;</span><span class="s2">password</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">password</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"></span>
<span class="s2">                                }</span>
<span class="s2">                    }</span>
<span class="s2">      ]]&quot;</span>
    <span class="k">end</span>

    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>

  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>And then you can call:</p>

<div class="highlight"><pre><code class="ruby"><span class="no">EM</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span>
  <span class="n">ws</span> <span class="o">=</span> <span class="no">Faye</span><span class="o">::</span><span class="no">WebSocket</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;ws://127.0.0.1:8080/clients&#39;</span><span class="p">)</span>

  <span class="n">ws</span><span class="o">.</span><span class="n">on</span> <span class="ss">:open</span> <span class="k">do</span> <span class="o">|</span><span class="n">event</span><span class="o">|</span>
    <span class="no">SwitchboardClient</span><span class="o">::</span><span class="nb">open</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">ws</span><span class="o">.</span><span class="n">on</span> <span class="ss">:message</span> <span class="k">do</span> <span class="o">|</span><span class="n">event</span><span class="o">|</span>
    <span class="no">SwitchboardClient</span><span class="o">::</span><span class="n">message</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">ws</span><span class="o">.</span><span class="n">on</span> <span class="ss">:close</span> <span class="k">do</span> <span class="o">|</span><span class="n">event</span><span class="o">|</span>
    <span class="no">SwitchboardClient</span><span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>Follow this example tutorial to build your first switchboard client in Ruby.
This simple example, to be run in the command line, syncs attachments from a
users’ emails to his or her Dropbox.</p>
