<h2 id="getting-started">Getting Started</h2>

<ul>
  <li><a href="#markdown-header-switchboard-core">Core Application</a></li>
  <li><a href="#markdown-header-switchboard-client-protocol">Client Protocol</a></li>
</ul>

<h3 id="switchboard-core">Switchboard Core</h3>

<p>This section is for people who want to develop on the core Switchboard
application.</p>

<p>Note: through the rest of this section, <code>./switchboard</code> will refer
to the release’s control script, located in <code>_rel/bin/switchboard</code>
if you’re building from source.</p>

<h3 id="switchboard-client-protocol">Switchboard Client Protocol</h3>

<p>This section is for people who want to write a Switchboard client, or
learn how Swithcboard communicates with clients.</p>

<p>TODO describe differences between client / worker</p>

<h4 id="a-subset-of-jmap">A Subset of JMAP</h4>

<p>At the moment, the Switchboard client protocol is a subset of
<a href="http://jmap.io">jmap</a>. The first 8 chapters of the jmap spec provides
a rationale for using JMAP over HTTP/websockets, the structure
of a JMAP exchange, the data model, and data types.</p>

<p>TL;DR: a client connects to the server over a websocket.  If you’re
running Switchboard locally, the url defaults to
<code>ws://127.0.0.1:8080/clients</code>. Data is encoded in UTF8 JSON. Clients
issue a list of commands to the server in the form form
<code>[[${method &lt;string&gt;}, ${args &lt;object&gt;}, ${tag (optional)}], ...]</code>.
The server runs the commands in order, generating and returning a list
of one respsone per command. The responses take the same form as the
commands. The examples below should be a bit more clean than my made
up pseudocode.</p>

<h4 id="connect"><code>connect</code></h4>

<p>A high level description is provided
<a href="http://jmap.io/#transport-and-authentication">here</a>, but
the details have been left up to the implementer. <code>connect</code>
accepts the <code>host</code> and <code>port</code> of the IMAP server, as well
as an <code>auth</code> object that is used to login after connecting
to the server. A <code>connected</code> response indicates that
the connection and login was successful.</p>

<p>Using plain auth:</p>

<pre><code>C: [["connect", {"host": "imap.gmail.com",
                 "port": 993,
				 "auth": {
				   "type": "plain",
				   "username": "username@gmail.com",
				   "password": "drowssap"}}]]
S: [["connected", {}]]
</code></pre>

<p>Using XOAUTH2:</p>

<pre><code>C: [["connect", {"host": "imap.gmail.com",
                 "port": 993,
				 "auth": {
				   "type": "xoauth2",
				   "username": "dispatchonme@gmail.com",
				     "token": {
					   "type": "refresh",
				       "token": "1/kif0yuTDHWu7UKtTCNtgDWTeoj_IYZM-SPmyxNiDCjc",
				       "url": "https://accounts.google.com/o/oauth2/token"}}}]]
S: [["connected", {}]]
</code></pre>

<h4 id="watchmailboxes"><code>watchMailboxes</code></h4>

<p>The <code>watchMailboxes</code> command tells the server to create IMAP connections for the
set of mailboxe names listed. It is not a part of the jmap spec.
If the server failed to create any connections, it will include a
<code>failed</code> key in the response args with a list of failed mailbox names.</p>

<p>Each call of “watchMailboxes” replaces the list of mailboxes being monitored.</p>

<pre><code>C: [["watchMailboxes", {"list": ["INBOX", "NON-EXISTENT"]}]]
S: [["watchingMailboxes", {"failed": ["NON-EXISTENT"]}]]

# The server will send unsolicited responses
S: [["newMessage", {"mailboxId": "INBOX!1", "messageId": "INBOX!1?17"}]]
</code></pre>

<h4 id="getmailboxeshttpjmapiogetmailboxes"><a href="http://jmap.io/#getmailboxes"><code>getMailboxes</code></a></h4>

<p>Returns a list of all mailbox objects.</p>

<pre><code>C: [["getMailboxes", {}]]
S: [["mailboxes", {"state": 79153751884907,
                   "list": [{"name": "INBOX",
                             "id": "INBOX-1"}]}]]

C: [["getMailboxes", {"state": 79153751884907}]]
S: [["mailboxes", {"state": 79153751884907}]]
</code></pre>

<p>TODO - ACL Permissions</p>

<h4 id="getmessagelisthttpjmapiogetmessagelist"><a href="http://jmap.io/#getmessagelist"><code>getMessageList</code></a></h4>

<pre><code>C: [["getMessageList", {"mailboxId": "INBOX!1"}]]
S: [["messageList", {"messageIds": ["INBOX!1?1", "INBOX!1?2", "INBOX!1?3"]}]]
</code></pre>

<p>TODO: All of the options, searching.</p>

<h4 id="getmessageshttpjmapiogetmessages"><a href="http://jmap.io/#getmessages"><code>getMessages</code></a></h4>

<pre><code>C: [["getMessages", {"ids": ["INBOX!1?3", "INBOX!1?4"],
                     "properties": ["subject", "to", "from", "textBody"]}]]
S: [["messages", {"state": "TODO",
                  "list": [
				    {
					  "textBody": "--bcaec5171e1f3f872b04fa044bc7\r\nContent-Type: text/plain; [...]",
					  "from":[{"name": "YouTube", "email": "noreply@youtube.com"}]
					  "to": [{"name": "", "email": "mail.dispatch.test@gmail.com"}],
					  "subject": "Pokemon dubstep, Harry Potter in cyberpunk and more '90s remixes on YouTube"
					}, {
					  "textBody": "--047d7b86e65445cc6c04fa33c13a\r\nContent-Type: text/plain; [...]",
					  "from": [{"name": "Google+", "email": "noreply-68620fcd@plus.google.com"}],
					  "to": [{"name": "", "email": "mail.dispatch.test@gmail.com"}],
					  "subject": "Top suggested Google+ Pages for you"
					}]}]]
</code></pre>

<h4 id="example-client">Example Client</h4>

<p>An example client written in javascript is located in
<a href="../priv/static/js/switchboardclient.js"><code>client/switchboardclient.js</code></a>. The
sourcefile contains comments mapping out common components of a
Switchboard client, and is a great reference for understanding how the
protocol works.</p>

<p>To try the client out, start the Switchboard application and point
your browser <a href="http://127.0.0.1:8080/jsclient">here</a>,
and it should display a page with some getting started commands. Open
your browser’s javascript console and try them out.</p>
